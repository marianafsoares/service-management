<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="mappers.ProviderExpenseMapper">

    <resultMap id="ProviderInvoiceResultMap" type="models.ProviderInvoice">
        <id property="id" column="id"/>
        <result property="invoiceNumber" column="invoice_number"/>
        <result property="pointOfSale" column="point_of_sale"/>
        <result property="description" column="description"/>
        <result property="receiverCuit" column="receiver_cuit"/>
        <result property="invoiceType" column="invoice_type"/>
        <result property="invoiceDate" column="invoice_date"/>
        <result property="presentationDate" column="presentation_date"/>
        <result property="subtotal" column="subtotal"/>
        <result property="vat21" column="vat_21"/>
        <result property="vat105" column="vat_105"/>
        <result property="vat27" column="vat_27"/>
        <result property="vatPerception" column="vat_perception"/>
        <result property="grossIncomePerception" column="gross_income_perception"/>
        <result property="incomeTaxPerception" column="income_tax_perception"/>
        <result property="exemptAmount" column="exempt_amount"/>
        <result property="stampTax" column="stamp_tax"/>
        <result property="total" column="total"/>
        <result property="createdAt" column="created_at"/>
        <result property="updatedAt" column="updated_at"/>
        <association property="provider" javaType="models.Provider">
            <id property="id" column="provider_id"/>
            <result property="name" column="provider_name"/>
            <result property="documentNumber" column="provider_cuit"/>
        </association>
        <association property="category" javaType="models.InvoiceCategory">
            <id property="id" column="category_id"/>
            <result property="description" column="category_description"/>
        </association>
    </resultMap>

    <select id="findCategories" resultType="string">
        SELECT CAST(id AS CHAR) FROM invoice_category
        WHERE type = 'PROVIDER'
        ORDER BY id
    </select>

    <select id="findByDateRangeAndCategory" resultMap="ProviderInvoiceResultMap">
        SELECT pi.*, ic.description AS category_description,
               p.full_name AS provider_name, p.document_number AS provider_cuit
        FROM provider_invoice pi
        JOIN invoice_category ic ON ic.id = pi.category_id
        JOIN provider p ON p.id = pi.provider_id
        WHERE pi.invoice_date BETWEEN #{start} AND #{end}
          AND pi.category_id = #{category}
    </select>

</mapper>

